<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracking - ShuddhMart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvlkUoMDy0HHlORg_iGpfqm8awIZLhlG4",
            authDomain: "shuddhmart.firebaseapp.com",
            databaseURL: "https://shuddhmart-default-rtdb.firebaseio.com/",
            projectId: "shuddhmart",
            storageBucket: "shuddhmart.firebasestorage.app",
            messagingSenderId: "899103384312",
            appId: "1:899103384312:web:4a8c638ba63654993f110d"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.getDatabase = () => database;
        window.ref = ref;
        window.get = get;
        window.child = child;
    </script>
    
    <style>
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-step.active {
            background-color: #10b981;
            color: white;
        }
        .progress-step.completed {
            background-color: #10b981;
            color: white;
        }
        .progress-line {
            height: 2px;
            background-color: #e5e7eb;
            transition: all 0.3s ease;
        }
        .progress-line.completed {
            background-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-600 text-white p-3 rounded-lg">
                        <i class="fas fa-store text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ShuddhMart</h1>
                        <p class="text-sm text-gray-600">Order Tracking</p>
                    </div>
                </div>
                <button onclick="window.close()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>
        </div>
    </header>

    <!-- Tracking Content -->
    <div class="container mx-auto px-4 py-8">
        <div id="trackingContent" class="max-w-4xl mx-auto">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-block w-8 h-8 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
                <p class="text-gray-600 mt-4">Loading order details...</p>
            </div>
            
            <!-- Order Details will be populated here -->
        </div>
    </div>

    <script>
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        if (!orderId) {
            document.getElementById('trackingContent').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Order ID Missing</h2>
                    <p class="text-gray-600">Please provide a valid order ID to track your order.</p>
                </div>
            `;
        } else {
            loadOrderDetails(orderId);
        }

        async function loadOrderDetails(orderId) {
            const dbRef = ref(getDatabase());
            try {
                const snapshot = await get(child(dbRef, `orders/${orderId}`));
                if (snapshot.exists()) {
                    const order = snapshot.val();
                    displayOrderTracking(order);
                } else {
                    showOrderNotFound();
                }
            } catch (error) {
                console.error("Error loading order:", error);
                showErrorState();
            }
        }

        function displayOrderTracking(order) {
            const trackingSteps = [
                { id: 'placed', label: 'Order Placed', icon: 'fas fa-check-circle' },
                { id: 'confirmed', label: 'Order Confirmed', icon: 'fas fa-clipboard-check' },
                { id: 'processing', label: 'Processing', icon: 'fas fa-cogs' },
                { id: 'shipped', label: 'Shipped', icon: 'fas fa-truck' },
                { id: 'delivered', label: 'Delivered', icon: 'fas fa-home' }
            ];

            const currentStatus = order.status || 'placed';
            const currentIndex = trackingSteps.findIndex(step => step.id === currentStatus.toLowerCase());

            document.getElementById('trackingContent').innerHTML = `
                <!-- Order Header -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Order #${order.id}</h2>
                            <p class="text-gray-600">Placed on ${new Date(order.date).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-600">₹${order.total}</p>
                            <p class="text-sm text-gray-600">${order.items.length} items</p>
                        </div>
                    </div>
                </div>

                <!-- Progress Tracking -->
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Order Status</h3>
                    <div class="flex items-center justify-between mb-8">
                        ${trackingSteps.map((step, index) => `
                            <div class="flex flex-col items-center flex-1">
                                <div class="progress-step w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold mb-2 ${
                                    index <= currentIndex ? 'completed' : 'bg-gray-200 text-gray-500'
                                }">
                                    <i class="${step.icon}"></i>
                                </div>
                                <p class="text-xs text-center ${index <= currentIndex ? 'text-green-600 font-medium' : 'text-gray-500'}">${step.label}</p>
                                ${index < trackingSteps.length - 1 ? `
                                    <div class="progress-line w-full mt-4 ${index < currentIndex ? 'completed' : ''}"></div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center">
                        <p class="text-lg font-medium text-gray-800">Current Status: ${order.status || 'Order Placed'}</p>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Customer Info -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Customer Information</h3>
                        <div class="space-y-2">
                            <p><strong>Name:</strong> ${order.customer.name}</p>
                            <p><strong>Email:</strong> ${order.customer.email}</p>
                            <p><strong>Phone:</strong> ${order.customer.phone}</p>
                        </div>
                    </div>

                    <!-- Delivery Info -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Delivery Information</h3>
                        <div class="space-y-2">
                            <p><strong>Address:</strong> ${order.delivery.address}</p>
                            <p><strong>Pincode:</strong> ${order.delivery.pincode}</p>
                            <p><strong>Payment:</strong> ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment'}</p>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Order Items</h3>
                    <div class="space-y-3">
                        ${order.items.map(item => `
                            <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                <div>
                                    <p class="font-medium">${item.name}</p>
                                    <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
                                </div>
                                <p class="font-medium">₹${item.price * item.quantity}</p>
                            </div>
                        `).join('')}
                        <div class="flex justify-between items-center pt-4 font-bold text-lg">
                            <p>Total Amount:</p>
                            <p class="text-green-600">₹${order.total}</p>
                        </div>
                    </div>
                </div>
            `;

            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
        }

        function showOrderNotFound() {
            document.getElementById('trackingContent').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Order Not Found</h2>
                    <p class="text-gray-600">The order ID "${orderId}" could not be found in our system.</p>
                </div>
            `;
        }

        function showErrorState() {
            document.getElementById('trackingContent').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Error Loading Order</h2>
                    <p class="text-gray-600">There was an error loading your order details. Please try again.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
